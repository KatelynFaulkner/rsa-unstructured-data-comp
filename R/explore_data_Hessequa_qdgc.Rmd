---
title: "Explore and compare structured and unstructured data for Hessequa Atlas Area at QDGC resolution"
author: "Katelyn Faulkner"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# Load packages
library(tidyverse)      # Data wrangling and visualisation
library(here)           # Relative paths
library(sf)             # Work with spatial data
library(ggpubr)         # Correlations
library(DT)             # Data tables for html
library(vcd)            # Kappa statistics
library(vegan)          # Bray kurtis index
library(RColorBrewer)   # Colour palette
```

# Goal

Explore structured data of the Hessequa systematic atlasing subproject of the “Southern African Bird Atlas Project 2” (SABAP2).

Explore unstructured data from GBIF for the same area.

Structured and unstructured data were prepared at both quarter degree grid cell (QDGC) and pentad (5 min x 5 min) scales, but only QDGC scale data is explored and analysed below.

QDGC is not ideal for data exploration and comparison, as the pentads in Hessequa Altas Area do not fully cover all the QDGC in which they fall. Therefore although at the same resolution, the structured and unstructured data do not overlap perfectly.

In these analysis various subsets of the data were explored
1. All species in SABAP2
2. All species with > 100 records in SABAP2
3. Number of observations per species/total number of observations

Data for two time periods explored 2015-2024 and 2015-2022

```{r}
# Create a custom color scale
library(RColorBrewer)
myColors <- brewer.pal(5, "Dark2")
names(myColors) <- c("Very rare", "Rare", "Common",
                     "Very common", "Extremely common")
colScale <- scale_color_manual(name = "Category",
                                values = myColors)
fillScale <- scale_fill_manual(name = "Category",
                                values = myColors)
```


# Load data

## Structured data

### Sampling framework

The sampling framework was prepared and stored as a geopackage file in *./data/interim*.

We read in the dataset.

```{r}
# Data path
data_path <- here::here("data", "interim")
```

```{r}
# Read SABAP2 Hessequa atlas area sampling framework (QDGC)
HAASF <- read_sf(file.path(data_path, "sampling_framework_SABAP2_QDGC.gpkg"))

# Explore dataframe
glimpse(HAASF)
```

### Occurrence data

The SABAP2 data were prepared and stored as a geopackage file in *./data/interim*.

We read in the dataset.

```{r}
# Read SABAP2 Hessequa atlas area bird data (QDGC)
SABAP2HAAinterim <- read_sf(file.path(data_path, "SABAP2_QDGC_HAA_data.gpkg"))

# Explore dataframe
glimpse(SABAP2HAAinterim)
```


## Unstructured data cube

Unstructured data from GBIF were prepared and stored as a geopackage file in *./data/interim*.

We read in the dataset.

```{r}
# Read in unstructured Hessequa atlas area bird data (QDGC)
UnstrucHAAinterim <- read_sf(file.path(data_path, "birdcube_QDGC_year_HAA.gpkg"))

# Explore dataframe
glimpse(UnstrucHAAinterim)
```

# Explore SABAP2 data

The Hessequa Atlas Area is a ~110 x 55 km area near Stillbaai in the Western Cape of South Africa. In this area of the country, ongoing directed, systematic bird surveys following the Southern African Bird Atlas Programme 2(SABAP2) standard protocol have been conducted since October 2014. The data are collected following a standardised protocol (i.e., BirdMap protocol), whereby at least two hours, but a maximum of five days, are spent recording as many different bird species in the grid cell as possible, with the end of each hour of the survey noted. The data are available at a 5-minute^2^ spatial resolution, which equates to a resolution of ~ 8.2 km^2^ in southern Africa. The area covers 75 grid cells. Although the frequency of the surveys has changed over time, every grid cell has been surveyed at least once every year by the same group of people. The surveys are as follows:

2015 and 2016: at least one standardised survey of each grid cell per year

2017: at least two standardised surveys of each grid cell

2018–2021: at least two standardised surveys of each grid cell per year, evenly spread over the seasons

2021–current: at least one standardised survey of each grid cell per year, distributed evenly over the seasons

The downloaded sampling framework data contains 77 grid cells (the extras are 3420_2055 and 3415_2140).

The data explored here have been prepared at quarter degree grid cell (QDGC) resolution - 9 pentads fit into a QDGC. 

In the bird record data, it was noted that there were 2016 records where 'species' was NA. Further investigation (examination of scientificName) indicated that these records were not identified to species level and were for:

"Zosterope": a synonym according to GBIF of Zosterops Vigors & Horsfield, 1827

"Psalidoprocne Cabanis, 1850"

"Buteo Lacepede, 1799"

"Sylvia Scopoli, 1769"    

"Anas Linnaeus, 1758"  

These records were removed for the analysis. But note there are species missing in this dataset that fall under these genera (see below).

## Survey data

```{r}
# Drop geometry, convert to long format, convert year into two-year cycles
HAASFprep <-HAASF %>% st_drop_geometry() %>%
pivot_longer(
  cols = '2015':'2024',
  names_to = c("year"),
  values_to = "count"
) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(cyclus = case_when(
    year == 2015 | year == 2016 ~ 1,
    year == 2017 | year == 2018 ~ 2,
    year == 2019 | year == 2020 ~ 3,
    year == 2021 | year == 2022 ~ 4,
    year == 2023 | year == 2024 ~ 5,
    ))
```

Summary of data:

```{r}
# summary
summary(HAASFprep[, c("year",
                          "count")])
```

Data collected between 2015 and 2024. Mean  of > 17 surveys per year per QDGC

```{r}
# total number of surveys
sum(HAASFprep$count) 
```

Total of 2667 surveys

```{r}
# Number of surveys per year
HAASFprep %>%
  group_by(year) %>%
    summarise(n = sum(count)) %>%
  ggplot(aes(x = year, y = n)) +
  geom_col(fill = "#1B9E77") +
  labs(x = "Year",
       y = "Number of surveys")+ scale_x_continuous(breaks=seq(2015,2024,1))
```

Number of surveys varies across years, and is between 200 and 330 surveys per year. No specific trend over time.

```{r}
# Number of surveys per QDGC
HAASFprep %>%
  group_by(qdgc) %>%
    summarise(n = sum(count)) %>%
  ggplot(aes(x = n)) +
  geom_histogram(fill = "#D95F02", color = "black") +
  labs(x = "Number of surveys",
       y = "Number of quarter-degree grid cells")
```

Number of surveys varies across the QDGC, one with > 600 surveys, five QDGC had > 200 surveys, while the remainder had < 200.

## Bird data

```{r}
# Drop geometry, removed records not identified to species level, classify commonness, and group years. Used two year internals
SABAP2HAA <-SABAP2HAAinterim %>% st_drop_geometry() %>%
filter(!is.na(species)) %>%
  mutate(cyclus = case_when(
    year == 2015 | year == 2016 ~ 1,
    year == 2017 | year == 2018 ~ 2,
    year == 2019 | year == 2020 ~ 3,
    year == 2021 | year == 2022 ~ 4,
    year == 2023 | year == 2024 ~ 5,
    )) %>%
group_by(species) %>%
  mutate(n_obs = n()) %>%
  ungroup() %>%
  mutate(category = cut(n_obs,
                        breaks = c(0, 10, 100, 1000, 10000, +Inf),
                        labels = c("Very rare", "Rare", "Common",
                                   "Very common", "Extremely common"),
                        right = FALSE))

# Group by species, year and QDGC
SABAP2HAAGrp <-SABAP2HAA %>% 
   group_by(species, year, qdgc, category) %>%
    summarise(n = n())

glimpse(SABAP2HAAGrp)
```

```{r}
summary(SABAP2HAA[, c("eventDate",
                          "year",
                          "month")])
```

Data run from January 2015 to February 2023. The period for which the data were downloaded were from January 2015 to December 2024. Data not being submitted to GBIF, or submission delayed.

```{r}
# total number of observations
length(SABAP2HAA$species) 
```

Over 100 000 bird records

```{r}
# Number of observations per year
SABAP2HAA %>%
  ggplot(aes(x = year(eventDate))) +
  geom_histogram(fill = "#1B9E77")
```

Number of observations has varied across the years. No specific trend. Number of observations range between 10 000 - 15 000 per year, excluding 2023. Note few observations for 2023, as only data up until February 2023 have been submitted to GBIF.

```{r}
# Number of observations per species
SABAP2HAAGrp %>%
  group_by(species) %>%
  summarise(n_obs = n()) %>%
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#D95F02", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

310 bird species recorded, of which 74 were recorded < 10 times (very rare), 80 were recorded between 10 and 100 times (rare), 123 were recorded between 100 and 1000 times (common),  and 33 were recorded between 1000 and 10000 times (very common). No birds species were recorded more than 10 000 times

```{r}
# Number of species falling into different commonness/observation categories
SABAP2HAA %>%
  distinct(category, species) %>%
  group_by(category) %>%
  summarise(n())
```

```{r}
# Number of observations per QDGC
SABAP2HAAGrp %>%
  group_by(qdgc) %>%
  summarise(n_obs = n()) %>%
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#7570B3", color = "black") +
  labs(x = "Number of observations",
       y = "Number of quarter-degree grid cells")
```

Number of observations vary across QDGC, one with ~ 500 observations, but most have > 750 observations, and one has > 1500 observations

```{r}
# Number of species per QDGC
SABAP2HAAGrp %>%
  group_by(qdgc) %>%
  summarise(nSpp = n_distinct(species)) %>%
  ggplot(aes(x = nSpp)) +
  geom_histogram(fill = "#E7298A", color = "black") +
  labs(x = "Number of species",
       y = "Number of quarter-degree grid cells")
```

Number of species recorded varies per QDGC. Most QDGC have between 165 and 225 species recorded, few have less than 135 species recorded, or greater than 225 species recorded.

# Compare bird data and survey data from SABAP2

```{r}
# Plot number of surveys vs number of observations
SABAP2HAA %>% 
   group_by(year, qdgc) %>%
    summarise(n = n()) %>%
  inner_join(HAASFprep,
            by = join_by(qdgc, year)) %>%
  ggplot(aes(x = n, y = count)) +
  geom_point(color = "#66A61E") +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") + labs(x = "Number of observations",
       y = "Number of surveys")
```

Strong correlation between number of surveys and number of observations

```{r}
# Plot number of surveys vs number of species
SABAP2HAA %>%
  group_by(qdgc, year) %>%
  summarise(nSpp = n_distinct(species)) %>%
  inner_join(HAASFprep,
            by = join_by(qdgc, year)) %>%
  ggplot(aes(x = nSpp, y = count)) +
  geom_point(color = "#1B9E77") +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") + labs(x = "Number of species",
       y = "Number of surveys")
```

Weaker correlation between number of surveys and number of species

# Explore Unstructured data cube for Hessequa Atlas Area

Unstructured data from GBIF for birds recorded in QDGC of Hessequa Atlas Area between 2015 and 2024. 

This cube was obtained through rgbif

```{r}
# Remove geometry and group years. Used two year internals
UnstrucHAA<- UnstrucHAAinterim %>%
  st_drop_geometry() %>%
  mutate(cyclus = case_when(
    year == 2015 | year == 2016 ~ 1,
    year == 2017 | year == 2018 ~ 2,
    year == 2019 | year == 2020 ~ 3,
    year == 2021 | year == 2022 ~ 4,
    year == 2023 | year == 2024 ~ 5,
  ))
```

```{r}
# Summary
summary(UnstrucHAA[, c("year")])
```

Data between 2015 and 2024

```{r}
# total number of observations
sum(UnstrucHAA$n) 
```

Total of 38678 observations. Less than from the SABAP2 data (over 100 000 bird records)

```{r}
# Number of observations per year
UnstrucHAA %>%
  group_by(year) %>%
  summarise(n_obs = sum(n)) %>%
  ggplot(aes(x = year, y = n_obs)) +
  geom_col(fill = "#7570B3") +
  labs(x = "Year",
       y = "Number of observations") + scale_x_continuous(breaks=seq(2015,2024,1))
```

The number of records was between ~2500 and 5000 per year  between 2015 and 2021, but subsequently increased to ~5500 in 2022, and > 8000 in 2023, and decreased to < 1750 in 2024. There were 44 publishers of the data that went into the cube for the Western Cape, however, the cube was subset spatially and temporally, and data from some publishers (e.g., SABAP) removed in the process. Likely the reduction in 2024 is due to a delay in records being recorded and then the data being uploaded to GBIF.

```{r}
# Number of observations per species
UnstrucHAA %>%
  group_by(species) %>%
  summarise(n_obs = sum(n)) %>%
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#E7298A", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

356 bird species recorded, of which 110 were recorded < 10 times (very rare), 120 were recorded between 10 and 100 times (rare), and 126 were recorded between 100 and 1000 times (common) No birds species were recorded more than 1000 times. 

```{r}
# Number of species in different observation/commoness categories
UnstrucHAA %>%
  group_by(species) %>%
  summarise(n_obs = sum(n)) %>%
  mutate(category = cut(n_obs,
                        breaks = c(-Inf, 0, 1, 10, 100, 1000, 10000, Inf),
                        right = FALSE)) %>%
  group_by(category) %>%
  summarise(n())
```

```{r}
# Number of observations per QDGC
UnstrucHAA %>%
  group_by(qdgc) %>%
  summarise(n_obs = sum(n)) %>%
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#66A61E", color = "black") +
  labs(x = "Number of observations",
       y = "Number of quarter-degree grid cell")
```

Most QDGC have < 1000 observations, few > 2500 observations. One over 10 000 observations.

```{r}
# Number of species per QDGC
UnstrucHAA %>%
  group_by(qdgc) %>%
  summarise(nSpp = n_distinct(species)) %>%
  ggplot(aes(x = nSpp)) +
  geom_histogram(fill = "#1B9E77", color = "black") +
  labs(x = "Number of species",
       y = "Number of quarter-degree grid cells")
```

Number of species varies across QDGC. One QDGC with > 250 species, and a few with < 100, most > 125 species

# Comparing structured and unstructured data (2015-2024)

Note the SABAP2 dataset used below contains only QDGC for Hessequa Atlas Area (15 QDGC), data from 2015 to 2023, and the geometry and NA species have been removed. Note data from 2023 is not complete.

The unstructured data used below contains only QDGC for Hessequa Atlas Area (15 QDGC), data from 2015 to 2024, and the geometry have been removed.  Note data from 2024 is not complete.

The total period 2015-2024 is used for comparison

```{r}
# species recorded in sabap2
studied_spec <- unique(SABAP2HAA$species) %>%
  na.omit()
```

## Species overlap between two datasets

```{r}
# calculate number and percentage of species in sabap2 that are in unstructured data
SppOverlapInd<-which(UnstrucHAA$species %in% studied_spec)
SppOverlap<-unique(UnstrucHAA$species[SppOverlapInd]) # overlapping species
NoSppOverlap<-length(SppOverlap)
PercSppOverlap<-NoSppOverlap/length(studied_spec)*100
NoSppOverlap # number of species in unstructured data that are in sabap2 data
PercSppOverlap # percentage of species in sabap2 data that are in unstructured data
```

292 species in both datasets. 94% of species in SABAP2 dataset are in the unstructured data

```{r}
# how common (based on sabap2) are the overlapping species, and not-overlapping species
ind<-which(SABAP2HAA$species %in% SppOverlap)
SppOverlapDeats<-unique(SABAP2HAA[ind,c('species', 'category')])
commonOverlap<-SppOverlapDeats %>%
group_by(category) %>%
  summarise(overlap = n())

SppNotOverlapDeats<-unique(SABAP2HAA[-ind,c('species', 'category')])
commonNotOverlap<-SppNotOverlapDeats %>%
group_by(category) %>%
  summarise(notOverlap = n())

commonOverlap %>%
left_join(commonNotOverlap, by = join_by(category)) %>%
  rowwise() %>%
  mutate(total = sum(overlap,notOverlap)) %>%
 mutate(perc = overlap/total*100)
```

Of the 310 species in the SABAP2 data, 292 are in the unstructured data (94%). Of the 292, 59 are very rare, 77 are rare, 123 are common, and 33 very common. Of the 18 species in SABAP2 that are missing from the unstructured data 15 are very rare, and 3 are rare, none are common or very common. The percentage of SABAP2 species recorded in the unstructured data increased with commonness: 80% of very rare species were recorded, 96% of rare species were recorded, 100% of common and very common species were recorded.

```{r}
# calculate number and percentage of species in unstructured data that are in SABAP2
SppOverlapInd2<-which(studied_spec %in% UnstrucHAA$species)
SppOverlap2<-unique(studied_spec[SppOverlapInd2]) # overlapping species
NoSppOverlap2<-length(SppOverlap2)
PercSppOverlap2<-NoSppOverlap2/length(unique(UnstrucHAA$species))*100
PercSppOverlap2 # percentage of species in unstructured data that are in SABAP2
```

82% of the species in the unstructured data are in SABAP2

```{r}
# what are these not-overlapping species
ind2<-which(UnstrucHAA$species %in% SppOverlap2)
SppNotOverlap2<-unique(UnstrucHAA[-ind2,])
SppNotOverlapDeats2<-unique(UnstrucHAA[-ind2,c('species')])

SppNotOverlap2 %>%
group_by(species) %>%
  summarise(nObs = sum(n)) %>%
   ggplot(aes(x = nObs)) +
  geom_histogram(fill = "#1B9E77", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

There are 64 species in the unstructured data that are not in the SABAP2 data. For 50 of these species there are < 20 records. For the 14 species for which there are > 20 records, the details are below. However, of these 14, while a few are likely to occur in the area, a number seem to be missidentifications or there are multiple accepted species names in GBIF. Note the SABAP2 data does go through quality control. All comparisons below are based on the species in SABAP2.

- *Tychaedon coryphoeus* (Karoo scrub-robin) (29 records): Two accepted species names in GBIF (*Tychaedon coryphoeus* (Lesson, 1831) and *Erythropygia coryphoeus* (Vieillot, 1817)). Appears in SABAP2 under *Erythropygia coryphoeus*.

- *Acrocephalus scirpaceus* (common reed warbler) (32 records). This species is a rare summer visitor with few records in southern Africa. Possible missidentifications.

- *Anthus nicholsoni* (Nicholson's Pipit) (33 records): Also an accepted species name in GBIF is *Anthus similis* (Jerdon, 1840), for which the common names are Long-billed pipit (in English) and Nicholsonkoester (in Afrikaans).  *Anthus similis* is in the SABAP2 data.

- *Phoenicopterus roseus* (greater flamingo) (42 records): As with lesser flamingo is a local visitor. Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

- *Dessonornis caffer* (Cape Robin-Chat) (48 records): Cape Robin-Chat appears to have two accepted species names in GBIF (*Cossypha caffra* (Linnaeus, 1771) and *Dessonornis caffer* (Linnaeus, 1771)). It is under *Cossypha caffra* in SABAP2.
	
- *Macronyx capensis* (Cape Longclaw) (63 records): Area does appear to be part of range. Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

- *Milvus migrans* (Black kite) (131 records): A summer visitor mostly to the north of the country. Possible missidentifications? Can be confused with Yellow-billed kite (*Milvus aegyptius*), which is included in SABAP2

- *Psalidoprocne pristoptera* (black saw-wing) (176 records): area is within its range. Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

- *Upupa epops* (Hoopoe) (199 records): two accepted species names in GBIF (*Upupa epops* Linnaeus, 1758 and *Upupa africana* Bechstein, 1811). The species appears under the name *Upupa africana* in SABAP2 data.

- *Buteo buteo* (buzzard) (221 records): A summer visitor, but it is very similar to Buteo trizonatus (difficult to tell a part), which is a resident in the area, and is in the SABAP2 data. Possible missidentifications? Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

- *Phalacrocorax carbo* (common cormorant) (224 records): possible misidentification. Maybe being confused with *Phalacrocorax capensis* (cape cormorant), which does occur in the area and is in the SABAP2 data.

- *Certhilauda curvirostris* (Cape Lark) (248 records): Range restricted species, which does not occur in the area. Possible missidentifications? Maybe confused with *Certhilauda brevirostris* (Agulhas lark), which does occur in this area, and is included in the SABAP2 data.

- *Euplectes capensis* (yellow bishop) (270 records): area is in range. Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

- *Zosterops virens* (Cape white-eye) (613 records): two accepted names in GBIF (*Zosterops virens* Sundevall, 1850 and *Zosterops capensis* Sundevall, 1850). Area is in range, but it appears under neither name in SABAP2 data. Many records in Western Cape for this species on SABAP2 website, but does not appear in data downloaded from GBIF.

## Range overlap

```{r}
# function to compare ranges from the two datasets
range_comp <- function(sel_species, period = 2015:2024,
                       dataset1 = SABAP2HAA,
                       dataset2 = UnstrucHAA) {

  # We filter both datasets for the species and period of interest
  # and group them by qdgc
  set_sabap2 <- dataset1 %>%
    st_drop_geometry() %>%
    filter(.data$species %in% sel_species,
           .data$year %in% period) %>%
    group_by(.data$qdgc) %>%
    summarise(n = n()) # no observations 

  set_cube <- dataset2 %>%
    st_drop_geometry() %>%
    filter(.data$species %in% sel_species,
           .data$year %in% period) %>%
    group_by(.data$qdgc) %>%
    summarise(n = sum(.data$n))

  total_sabap2 <- length(set_sabap2$qdgc)
  perc_sabap2 <- (total_sabap2 / 15) * 100 # have taken the value to be total number of grid cells in area of interest
  
  total_cube <- length(set_cube$qdgc)
  perc_cube <- (total_cube / 15) * 100 # have taken the value to be total number of grid cells in area of interest

  overlap_all_sabap2_cube <- length(
    which(set_cube$qdgc %in% unique(dataset1$qdgc))
    )
  perc_overlap_all <- (overlap_all_sabap2_cube / 15) * 100 # have taken the value to be total number of grid cells in the sabap2 data

  total_overlap <- length(which(set_cube$qdgc %in% set_sabap2$qdgc))
  perc <- (total_overlap / total_sabap2) * 100 

  list(total_sabap2, perc_sabap2,
       total_cube, perc_cube,
       overlap_all_sabap2_cube, perc_overlap_all,
       total_overlap, perc)
}
```

```{r}
# run function
comp_range_data <- as.data.frame(studied_spec)
comp_range_data$sabap2_squares <- NA
comp_range_data$perc_sabap2_total_sabap2 <- NA
comp_range_data$cube_squares <- NA
comp_range_data$perc_cube_total_cube <- NA
comp_range_data$overlap_birdcube_total_sabap2 <- NA
comp_range_data$perc_birdcube_total_sabap2 <- NA
comp_range_data$overlap_birdcube_spec_sabap2 <- NA
comp_range_data$percentage_birdcube_spec_sabap2 <- NA

for (i in studied_spec){
  test <- range_comp(i, period = 2015:2024)
  
  comp_range_data[comp_range_data$studied_spec == i, 2] <- test[1]
  comp_range_data[comp_range_data$studied_spec == i, 3] <- test[2]
  comp_range_data[comp_range_data$studied_spec == i, 4] <- test[3]
  comp_range_data[comp_range_data$studied_spec == i, 5] <- test[4]
  comp_range_data[comp_range_data$studied_spec == i, 6] <- test[5]
  comp_range_data[comp_range_data$studied_spec == i, 7] <- test[6]
  comp_range_data[comp_range_data$studied_spec == i, 8] <- test[7]
  comp_range_data[comp_range_data$studied_spec == i, 9] <- test[8]
}
```

```{r}
# Table of output
comp_range_data %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  DT::datatable() %>%
  DT::formatRound(columns = c("perc_sabap2_total_sabap2",
                              "perc_cube_total_cube",
                              "perc_birdcube_total_sabap2",
                              "percentage_birdcube_spec_sabap2"), digits = 2)
```

This table shows the number of sabap2 grid cells (squares) where a species was observed, the percentage of total sabap2 grid cells, the number of cube grid cells were the species was observed, the percentage of all cube grid cells, the number of sabap2 grid cells where the species was observed based on the birdcube data, the percentage compared to all sabap2 grid cells, the number of grid cells occupied by the species in both the sabap2 and birdcube data and the percentage of this compared to the number of grid cells occupied by this species in the sabap2 data.

```{r}
# summary of output
summary(comp_range_data)
```

Overall we see an overlap of 57.33%

```{r}
# plot percentage range overlap
comp_range_data %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = percentage_birdcube_spec_sabap2,fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Percentage range overlap",
       y = "Number of species")
```

Most species have over 50% range overlap. All species with very low range overlap are very rare or rare. All very common species have a range overlap of > 75%.

```{r}
# Plot percentage of SABAP2 grid cells in which species recorded in SABAP2 vs percentage overlapping cells in cube
comp_range_data %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_birdcube_total_sabap2, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")
```

If we look at the graph it appears that of the sabap2 grid cells the percentage of grid cells in which a species is observed in sabap2 is strongly positively correlated to the percentage grid cells in which there is overlap between the sabap2 records and cube records.

### All species in SABAP2

```{r}
# Plot percentage of SABAP2 grid cells in which species recorded in SABAP2 vs percentage of cells in which recorded in unstructured data
comp_range_data %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_cube_total_cube, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")+
  labs(x = "Percentage of SABAP2 squares occupied\nby species in SABAP2 dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset")
```

If we look at the graph it appears that of the sabap2 grid cells the percentage of grid cells in which a species is observed in sabap2 is positively correlated to the percentage grid cells in which a species is recorded in the unstructured data. 

### Only common and very common species in SABAP2

```{r}
# same plot as previous, but not including rare and very rare species
comp_range_data %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  filter(category %in% c("Common", "Very common", "Extremely common")) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_cube_total_cube, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")+
  labs(x = "Percentage of SABAP2 squares occupied\nby species in SABAP2 dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset")
```

For common and very common species (rare excluded) - If we look at the graph it appears that of the SABAP2 grid cells the percentage of grid cells in which a species is observed in SABAP2 is positively correlated to the percentage grid cells in which a species is recorded in the unstructured data. The correlation in weaker than when rare species are included.

## Range overlap over time

```{r}
# Calculate range overlap metrics for two-year periods
comp_range_data2 <- data.frame(studied_spec = rep(studied_spec, 5),
                               sabap2_squares = NA,
                               perc_sabap2_total_sabap2 = NA,
                               cube_squares = NA,
                               perc_cube_total_cube = NA,
                               percentage_birdcube_spec_sabap2 = NA, #added
                               cyclus = NA)

start_year <- 2015
end_year <- 2024

cycle_starts <- seq(from = start_year, to = end_year, by = 2)
c = 1
j = 1

for (cycle_start in cycle_starts) {
  for (i in studied_spec) {
    comp_range_data2$cyclus[j] <- c
    comp_range_data2$studied_spec[j] = i
    
    test <- range_comp(i, period = cycle_start:(cycle_start + 2))
    
    comp_range_data2$sabap2_squares[j] <- test[[1]]
    comp_range_data2$perc_sabap2_total_sabap2[j] <- test[[2]]
    comp_range_data2$cube_squares[j] <- test[[3]]
    comp_range_data2$perc_cube_total_cube[j] <- test[[4]]
    comp_range_data2$percentage_birdcube_spec_sabap2[j] <- test[[8]] # added
    
    j = j + 1
  }
  c = c + 1
}
```

```{r}
# Plot percentage cells in which species were recorded in sabap2 vs in unstructured data for each two-year period
comp_range_data2 %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_cube_total_cube, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") +
  facet_grid("cyclus",
             scales = "free_y") + labs(x = "Percentage of SABAP2 squares occupied by species in SABAP2 dataset",
       y = "Percentage of cube squares occupied by species in cube dataset")
```

The positive correlation between percentage grid cells in SABAP2 data and cube holds if we look at different time periods. Time period 1 = 2015 and 2016, time period 2 = 2017 and 2018, time period 3 = 2019 and 2020, time period 4 = 2021 and 2022, and time period 5 = 2023 and 2024. Note the results from 2023/2024 look odd as very little SABAP2 data submitted to GBIF for this period, and unstructured data is also reduced for 2024.

```{r}
# plot percentage range overlap for each period
comp_range_data2 %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = percentage_birdcube_spec_sabap2,fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Percentage range overlap",
       y = "Number of species") + facet_grid("cyclus", scales = "free_y")
```

Overtime, the percentage of range overlap has increased. Generally, poorer for all time periods for very rare and rare species.

# Comparing structured and unstructured data (2015-2022)

Below is the same analysis as above but the period of data covered are for 2015-2022, when both SABAP2 and unstructured data are available.

Note, while the specific values vary the results and conclusions are similar to that for the period 2015-2024

```{r}
# remove data from 2023 and 2024
SABAP2HAASub<-SABAP2HAA %>%
  filter(cyclus != "5")

UnstrucHAASub<-UnstrucHAA %>%
  filter(cyclus != "5")
```


```{r}
# species recorded in sabap2
studied_spec <- unique(SABAP2HAASub$species) %>%
  na.omit()
```

## Species overlap between two datasets

```{r}
# calculate number and percentage of species in sabap2 that are in unstructured data
SppOverlapSubInd<-which(UnstrucHAASub$species %in% studied_spec)
SppOverlapSub<-unique(UnstrucHAASub$species[SppOverlapSubInd]) # overlapping species
NoSppOverlapSub<-length(SppOverlapSub)
PercSppOverlapSub<-NoSppOverlapSub/length(studied_spec)*100
NoSppOverlapSub # number of species in unstructured data that are in sabap2 data
PercSppOverlapSub # percentage of species in sabap2 data that are in unstructured data
```

286 species appear in both the structured and unstructured datasets, this represents 92% of the species recorded in SABAP2.

```{r}
# how common (based on sabap2) are the overlapping species, and not-overlapping species
ind<-which(SABAP2HAASub$species %in% SppOverlapSub)
SppOverlapDeatsSub<-unique(SABAP2HAASub[ind,c('species', 'category')])
commonOverlap<-SppOverlapDeatsSub %>%
group_by(category) %>%
  summarise(overlap = n())

SppNotOverlapDeatsSub<-unique(SABAP2HAASub[-ind,c('species', 'category')])
commonNotOverlap<-SppNotOverlapDeatsSub %>%
group_by(category) %>%
  summarise(notOverlap = n())

commonOverlap %>%
  left_join(commonNotOverlap, by = join_by(category)) %>%
  rowwise() %>%
  mutate(total = sum(overlap,notOverlap)) %>%
  mutate(perc = overlap/total*100)
```

Of the 310 species in the SABAP2 data (all appear in the period from 2015 to 2022), 286 are in the unstructured data (92%). Of the 286, 55 are very rare, 75 are rare, 123 are common, and 33 very common. Of the 24 species in SABAP2 that are missing from the unstructured data 19 are very rare, 5 are rare, and none are common or very common. The percentage of species recorded in the unstructured data increased with commonness: 74% of very rare species were recorded, 94% of rare species were recorded, 100% of common and very common species were recorded.

```{r}
# calculate number and percentage of species in unstructured data that are in SABAP2
SppOverlapIndSub2<-which(studied_spec %in% UnstrucHAASub$species)
SppOverlapSub2<-unique(studied_spec[SppOverlapIndSub2]) # overlapping species
NoSppOverlapSub2<-length(SppOverlapSub2)
PercSppOverlapSub2<-NoSppOverlapSub2/length(unique(UnstrucHAASub$species))*100
PercSppOverlapSub2 # percentage of species in unstructured data that are in SABAP2
```

84% of the species in the unstructured data are in SABAP2 (a few more than for the period 2015-2024)

```{r}
# what are these not-overlapping species
indsub2<-which(UnstrucHAASub$species %in% SppOverlapSub2)
SppNotOverlapSub2<-unique(UnstrucHAASub[-indsub2,])
SppNotOverlapSubDeats2<-unique(UnstrucHAASub[-indsub2,c('species')])

SppNotOverlapSub2 %>%
group_by(species) %>%
  summarise(nObs = sum(n)) %>%
   ggplot(aes(x = nObs)) +
  geom_histogram(fill = "#1B9E77", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

There are 54 species in the unstructured data that are not in the SABAP2 data. For 41 of these species there are < 20 records. For the 13 species for which there are > 20 records. These 13 species are discussed above (they were all missing in the 2015-2024 data too). All comparisons below are based on the species in SABAP2.

## Range overlap

```{r}
# function to compare ranges
range_comp <- function(sel_species, period = 2015:2022,
                       dataset1 = SABAP2HAASub,
                       dataset2 = UnstrucHAASub) {

  # We filter both datasets for the species and period of interest
  # and group them by QDGC
  set_sabap2 <- dataset1 %>%
    st_drop_geometry() %>%
    filter(.data$species %in% sel_species,
           .data$year %in% period) %>%
    group_by(.data$qdgc) %>%
    summarise(n = n()) # no observations rather than no individuals

  set_cube <- dataset2 %>%
    st_drop_geometry() %>%
    filter(.data$species %in% sel_species,
           .data$year %in% period) %>%
    group_by(.data$qdgc) %>%
    summarise(n = sum(.data$n))

  total_sabap2 <- length(set_sabap2$qdgc)
  perc_sabap2 <- (total_sabap2 / 15) * 100 # have taken the value to be total number of grid cells in area of interest
  
  total_cube <- length(set_cube$qdgc)
  perc_cube <- (total_cube / 15) * 100 # have taken the value to be total number of grid cells in area of interest

  overlap_all_sabap2_cube <- length(
    which(set_cube$qdgc %in% unique(dataset1$qdgc))
    )
  perc_overlap_all <- (overlap_all_sabap2_cube / 15) * 100 # have taken the value to be total number of grid cells in the sabap2 data

  total_overlap <- length(which(set_cube$qdgc %in% set_sabap2$qdgc))
  perc <- (total_overlap / total_sabap2) * 100 

  list(total_sabap2, perc_sabap2,
       total_cube, perc_cube,
       overlap_all_sabap2_cube, perc_overlap_all,
       total_overlap, perc)
}
```

```{r}
# run function
comp_range_data <- as.data.frame(studied_spec)
comp_range_data$sabap2_squares <- NA
comp_range_data$perc_sabap2_total_sabap2 <- NA
comp_range_data$cube_squares <- NA
comp_range_data$perc_cube_total_cube <- NA
comp_range_data$overlap_birdcube_total_sabap2 <- NA
comp_range_data$perc_birdcube_total_sabap2 <- NA
comp_range_data$overlap_birdcube_spec_sabap2 <- NA
comp_range_data$percentage_birdcube_spec_sabap2 <- NA

for (i in studied_spec){
  test <- range_comp(i, period = 2015:2022)
  
  comp_range_data[comp_range_data$studied_spec == i, 2] <- test[1]
  comp_range_data[comp_range_data$studied_spec == i, 3] <- test[2]
  comp_range_data[comp_range_data$studied_spec == i, 4] <- test[3]
  comp_range_data[comp_range_data$studied_spec == i, 5] <- test[4]
  comp_range_data[comp_range_data$studied_spec == i, 6] <- test[5]
  comp_range_data[comp_range_data$studied_spec == i, 7] <- test[6]
  comp_range_data[comp_range_data$studied_spec == i, 8] <- test[7]
  comp_range_data[comp_range_data$studied_spec == i, 9] <- test[8]
}
```

```{r}
# table of outputs
comp_range_data %>%
  inner_join(SABAP2HAASub %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  DT::datatable() %>%
  DT::formatRound(columns = c("perc_sabap2_total_sabap2",
                              "perc_cube_total_cube",
                              "perc_birdcube_total_sabap2",
                              "percentage_birdcube_spec_sabap2"), digits = 2)
```

This table shows the number of sabap2 grid cells where a species was observed, the percentage of total sabap2 grid cells, the number of cube grid cells were the species was observed, the percentage of all cube grid cells, the number of sabap2 grid cells where the species was observed based on the birdcube data, the percentage compared to all sabap2 grid cells, the number of grid cells occupied by the species in both the sabap2 and birdcube data and the percentage of this compared to the number of grid cells occupied by this species in th sabap2 data.

```{r}
# summary of output
summary(comp_range_data)
```

Overall we see a range overlap of 52%

```{r}
# plot percentage range overlap
comp_range_data %>%
  inner_join(SABAP2HAASub %>% distinct(species, category),
             by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = percentage_birdcube_spec_sabap2,fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Percentage range overlap", y = "Number of species")
```

Most species have ~ 50% or above percentage overlap. All very common species have percentage range overlap of > 60%, while all species with very low % range overlap are very rare or rare.

```{r}
# Plot percentage of SABAP2 grid cells in which species recorded in SABAP2 vs percentage overlapping cells in cube
comp_range_data %>%
  inner_join(SABAP2HAASub %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_birdcube_total_sabap2, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")
```

If we look at the graph it appears that of the sabap2 grid cells the percentage of grid cells in which a species is observed in sabap2 is strongly positively correlated to the percentage grid cells in which there is overlap between the sabap2 records and cube records. 

### All species in SABAP2

```{r}
# Plot percentage of SABAP2 grid cells in which species recorded in SABAP2 vs percentage of cells in which recorded in unstructured data
comp_range_data %>%
  inner_join(SABAP2HAASub %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_cube_total_cube, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")+
  labs(x = "Percentage of SABAP2 squares occupied\nby species in SABAP2 dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset")
```

If we look at the graph it appears that of the sabap2 grid cells the percentage of grid cells in which a species is observed in sabap2 is strongly positively correlated to the percentage grid cells in which a species is recorded in the unstructured data. 

### Only common and very common species in SABAP2

```{r}
# Plot percentage of SABAP2 grid cells in which species recorded in SABAP2 vs percentage of cells in which recorded in unstructured data (common and very common species only)
comp_range_data %>%
  inner_join(SABAP2HAASub %>% distinct(species, category),
            by = join_by(studied_spec == species)) %>%
  filter(category %in% c("Common", "Very common", "Extremely common")) %>%
  ggplot(aes(x = perc_sabap2_total_sabap2, y = perc_cube_total_cube, color = category)) +
  geom_point() +
  colScale +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson")+
  labs(x = "Percentage of SABAP2 squares occupied\nby species in SABAP2 dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset")
```

For common and very common species (rare excluded) - If we look at the graph it appears that of the sabap2 grid cells the percentage of grid cells in which a species is observed in sabap2 is positively correlated to the percentage grid cells in which a species is recorded in the unstructured data. But the correlation is stronger when all species are included.

# Trend analysis

## Trend comparison with data aggregated per year

### All species in SAPAP2

```{r}
# No records per year per species
time_series_Y1 <- SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(species, year) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT"))
```

```{r}
# No records per year per species
time_series_Y2 <- UnstrucHAA %>%
  st_drop_geometry()  %>%
  group_by(species, year)  %>%
  summarize(occurrence = sum(n)) 
```

```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_Y_cor <- time_series_Y1 %>%
  inner_join(time_series_Y2,
             by = c("species", "year"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
# summarise correlations per commonness group
time_series_Y_cor<-time_series_Y_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_Y_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_Y_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Graph shows for each species the degree to which the number of records over time in SABAP2 correlates with the number of records in the unstructured dataset. The strength and direction of the correlation varies significantly between species, but for most is strongly negative. Correlations are better for rare and very rare species.

### Common and very common species in SABAP2

```{r}
# No records per year per species
time_series_Y1Com <- SABAP2HAA %>%
  st_drop_geometry() %>%
  filter(category %in% c("Common", "Very common", "Extremely common")) %>%
  group_by(species, year) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT"))
```


```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_YCom_cor <- time_series_Y1Com %>%
  inner_join(time_series_Y2,
             by = c("species", "year"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
# summarise correlations per commonness group
time_series_YCom_cor<-time_series_YCom_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_YCom_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_YCom_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Graph shows for each species that is common or very common the degree to which the number of records over time in SABAP2 correlates with the number of records in the unstructured dataset. Correlations are poor.


### All species in SABAP2, but number of observations is weighed by total number of observations for that year

```{r}
# No records per year
total_year_1<-SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(year) %>%
  summarize(Totalocc = sum(occurrenceStatus == "PRESENT"))

time_series_Y1adj <- SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(species, year) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT")) %>% left_join(total_year_1) %>% mutate(occCorrect = occurrence/Totalocc)
```

```{r}
# No records per year
total_year_2<-UnstrucHAA %>%
  st_drop_geometry() %>%
  group_by(year) %>%
  summarize(Totalocc = sum(n))

# No records per year per species
time_series_Y2adj <- UnstrucHAA %>%
  st_drop_geometry()  %>%
  group_by(species, year)  %>%
  summarize(occurrence = sum(n)) %>% left_join(total_year_2) %>% mutate(occCorrect = occurrence/Totalocc)
```

```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_Yadj_cor <- time_series_Y1adj %>%
  inner_join(time_series_Y2adj,
             by = c("species", "year"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occCorrect_1, occCorrect_2, method = "pearson"))
```


```{r}
# summarise correlations per commonness group
time_series_Yadj_cor<-time_series_Yadj_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_Yadj_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_Yadj_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Graph shows for each species the degree to which the number of records over time in SABAP2 correlates with the number of records in the unstructured dataset. The strength and direction of the correlation varies significantly between species, but is improved in comparison to when the data are not corrected for total number of records.

## Trend comparison with data aggregated per cyclus

### All species in SAPAP2

```{r}
# No records per time-period per species
time_series_Cyc1 <- SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(species, cyclus) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT")) %>%
  filter(cyclus < 5)
```

```{r}
# No records per time-period per species
time_series_Cyc2 <- UnstrucHAA %>%
  st_drop_geometry()  %>%
  group_by(species, cyclus)  %>%
  summarize(occurrence = sum(n)) %>% 
  filter(cyclus < 5)
```

```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-time-period combinations present
# in both datasets are included
time_series_Cyc_cor <- time_series_Cyc1 %>%
  inner_join(time_series_Cyc2,
             by = c("species", "cyclus"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
# summarise correlations per commonness group
time_series_Cyc_cor<-time_series_Cyc_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_Cyc_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_Cyc_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Graph shows for each species the degree to which the number of records over time in SABAP2 correlates with the number of records in the unstructured dataset. The strength and direction of the correlation varies significantly between species. Is an improvement in comparison to when yearly data are assessed.

### Common and very common species in SABAP2

```{r}
# No records per time-period per species
time_series_Cyc1Com <- SABAP2HAA %>%
  st_drop_geometry() %>%
  filter(category %in% c("Common", "Very common", "Extremely common")) %>%
  group_by(species, cyclus) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT")) %>%
  filter(cyclus < 5)
```

```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-time-period combinations present
# in both datasets are included
time_series_CycCom_cor <- time_series_Cyc1Com %>%
  inner_join(time_series_Cyc2,
             by = c("species", "cyclus"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
# summarise correlations per commonness group
time_series_CycCom_cor<-time_series_CycCom_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_CycCom_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_CycCom_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Binning data into grouped years improves the correlations for common and very common species

### All species in SABAP2, but number of observations is weighed by total number of observations for that cyclus

```{r}
# No records per cyclus
total_cyc_1<-SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(cyclus) %>%
  summarize(Totalocc = sum(occurrenceStatus == "PRESENT"))

time_series_Cyc1adj <- SABAP2HAA %>%
  st_drop_geometry() %>%
  group_by(species, cyclus) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT")) %>%
  filter(cyclus < 5) %>% 
  left_join(total_cyc_1) %>% mutate(occCorrect = occurrence/Totalocc)
```

```{r}
# No records per cylus
total_cyc_2<-UnstrucHAA %>%
  st_drop_geometry() %>%
  group_by(cyclus) %>%
  summarize(Totalocc = sum(n))

# No records per time-period per species
time_series_Cyc2adj <- UnstrucHAA %>%
  st_drop_geometry()  %>%
  group_by(species, cyclus)  %>%
  summarize(occurrence = sum(n)) %>% 
  filter(cyclus < 5) %>%
  left_join(total_cyc_2) %>% mutate(occCorrect = occurrence/Totalocc)
```

```{r}
# Pearson Correlation for each species
# inner_join makes sure that only species-cyclus combinations present
# in both datasets are included
time_series_Cycadj_cor <- time_series_Cyc1adj %>%
  inner_join(time_series_Cyc2adj,
             by = c("species", "cyclus"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occCorrect_1, occCorrect_2, method = "pearson"))
```

```{r}
# summarise correlations per commonness group
time_series_Cycadj_cor<-time_series_Cycadj_cor %>%
  inner_join(SABAP2HAA %>% distinct(species, category),
             by = join_by(species == species)) 

time_series_Cycadj_cor %>%
  group_by(category) %>%
  summarize(mean(correlation, na.rm = TRUE))
```

```{r}
# Visualise results
time_series_Cycadj_cor %>%  
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  fillScale +
  labs(x = "Correlation",
       y = "Number of species")
```

Correlations are improved when number of observations per species are divided by total number of obserations

```{r}
# table of results
time_series_Cycadj_cor %>%
  filter(category %in% c("Common", "Very common", "Extremely common"),
         correlation < 0.5) %>%
  DT::datatable() %>%
  DT::formatRound(columns = "correlation", digits = 2)
```

## Trend similarity

```{r}
studied_spec <- unique(SABAP2HAA$species) %>% na.omit()
```

```{r}
# Calculate number of SABAP2 records per species per time period, and change from one period to the next
sabap2_dif <- SABAP2HAA %>%
  group_by(cyclus, species) %>%
  summarise(total = n()) %>% # no records in SABAP2 data
  pivot_wider(names_from = cyclus,
              names_prefix = "sabap2_",
              values_from = total,
              values_fill = 0) %>%
  mutate(dif1 = sabap2_2 - sabap2_1,
         dif2 = sabap2_3 - sabap2_2,
         dif3 = sabap2_4 - sabap2_3)
```

```{r}
# Calculate number of unstructured records per species per time period, and change from one period to the next
cube_dif <- UnstrucHAA %>%
  filter(species %in% studied_spec) %>%
  group_by(cyclus, species) %>%
  summarise(total = sum(n)) %>% # no records
  pivot_wider(names_from = cyclus,
              names_prefix = "cube_",
              values_from = total,
              values_fill = 0) %>%
  mutate(dif1_cube = cube_2 - cube_1,
         dif2_cube = cube_3 - cube_2,
         dif3_cube = cube_4 - cube_3) %>%
  select(species, dif1_cube, dif2_cube, dif3_cube)
```

```{r}
# Compare the changes over time periods per species between the two datasets
# TRUE if positive change, FALSE if negative change
comp_dir <- sabap2_dif %>%
  select(species, dif1, dif2, dif3) %>%
  inner_join(cube_dif) %>%
  mutate(dif1 = dif1 > 0,
         dif2 = dif2 > 0,
         dif3 = dif3 > 0,
         dif1_cube = dif1_cube > 0,
         dif2_cube = dif2_cube > 0,
         dif3_cube = dif3_cube > 0) %>%
  pivot_longer(
    cols = !species
  ) %>%
  mutate(set = ifelse(str_detect(name, "cube"),
                      "cube",
                      "sabap2")) %>%
  mutate(dif = str_sub(name, 1, 4)) %>%
  select(-name) %>%
  pivot_wider(names_from = set,
              values_from = value)
```

```{r}
# Perform Kappa analysis (how well do the two datasets agree in terms of change direction)
vcd::Kappa(table(comp_dir[,c(3,4)]))
```

K value  = 0.1414, so there is a 'slight' agreement in trends in number of records over time

```{r}
# Calculate number of SABAP2 records per rare species per time period, and change from one period to the next
sabap2_dif <- SABAP2HAA %>%
  filter(category %in% c("Rare")) %>%
  group_by(cyclus, species) %>%
  summarise(total = n()) %>% # no records
  pivot_wider(names_from = cyclus,
              names_prefix = "sabap2_",
              values_from = total,
              values_fill = 0) %>%
  mutate(dif1 = sabap2_2 - sabap2_1,
         dif2 = sabap2_3 - sabap2_2,
         dif3 = sabap2_4 - sabap2_3)
```

```{r}
# Calculate number of unstructured data records per rare species per time period, and change from one period to the next
cube_dif <- UnstrucHAA %>%
  filter(species %in% sabap2_dif$species) %>%
  group_by(cyclus, species) %>%
  summarise(total = sum(n)) %>%
  pivot_wider(names_from = cyclus,
              names_prefix = "cube_",
              values_from = total,
              values_fill = 0) %>%
  mutate(dif1_cube = cube_2 - cube_1,
         dif2_cube = cube_3 - cube_2,
         dif3_cube = cube_4 - cube_3) %>%
  select(species, dif1_cube, dif2_cube, dif3_cube)
```

```{r}
# Compare the changes over time periods per rare species between the two datasets
# TRUE if positive change, FALSE if negative change
comp_dir <- sabap2_dif %>%
  select(species, dif1, dif2, dif3) %>%
  inner_join(cube_dif) %>%
  mutate(dif1 = dif1 > 0,
         dif2 = dif2 > 0,
         dif3 = dif3 > 0,
         dif1_cube = dif1_cube > 0,
         dif2_cube = dif2_cube > 0,
         dif3_cube = dif3_cube > 0) %>%
  pivot_longer(
    cols = !species
  ) %>%
  mutate(set = ifelse(str_detect(name, "cube"),
                      "cube",
                      "sabap2")) %>%
  mutate(dif = str_sub(name, 1, 4)) %>% 
  select(-name) %>%
  pivot_wider(names_from = set,
              values_from = value)
```

```{r}
# Perform Kappa analysis (how well do the two datasets agree in terms of change direction)
vcd::Kappa(table(comp_dir[,c(3,4)]))
```

Kappa value = 0.0503 so there is a 'poor' agreement in trends in number of records over time

# Occupancy rate comparrison

```{r}
# Give '1' to the grid cells each species is recorded in SABAP2
occupancy_1 <- SABAP2HAA %>%
  group_by(species, qdgc) %>%
  summarize(occupancy_rate_1 = mean(occurrenceStatus == "PRESENT"))
```

```{r}
# Give '1' to the grid cells each species is recorded in unstructured data
occupancy_2 <- UnstrucHAA %>%
  group_by(species, qdgc) %>%
  summarize(occupancy_rate_2 = 1) 
```

```{r}
# Calculate per species, the number of cells occupied in SABAP2, number of cells occupied in unstructured data, and percentage of cells occupied in SABAP2 data that are occupied in unstructured data
occupancy<-occupancy_1 %>% left_join(occupancy_2,
            by = join_by(species, qdgc)) %>%
  replace_na(list(occupancy_rate_2 = 0)) %>%
  group_by(species)%>%
  summarise(SabapOcc = sum(occupancy_rate_1), UnstrucOcc = sum(occupancy_rate_2), PercOcc = (UnstrucOcc/SabapOcc)*100)

mean(occupancy$PercOcc) # average % occupancy overlap
```

Average occupancy across species is 57%. 57% of cells occupied in SABAP2 data are on average occupied in unstructured data

# Species richness and composition

```{r}
# Species richness per pentad
richness_1 <- SABAP2HAA %>%
  group_by(qdgc) %>%
  summarize(richnessSABAP2 = n_distinct(species))

richness_2 <- UnstrucHAA %>%
  filter(species %in% studied_spec) %>%
  group_by(qdgc) %>%
  summarize(richnessUnstruc = n_distinct(species))

# Plot correlation
richness_1 %>% left_join(richness_2,
            by = join_by(qdgc)) %>%
  replace_na(list(richnessUnstruc = 0)) %>%
    ggplot(aes(x = richnessSABAP2, y = richnessUnstruc)) +
  geom_point(color = "#1B9E77") +
  ggpubr::stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") 

```

No correlation between species richness calculated from the two datasets

```{r}
# Bray-Curtis dissimilarity
# Number of records per species in sabap2
species_composition_1 <- SABAP2HAA %>%
  drop_na(species) %>% 
  count(species) %>% # number of records per species
  pivot_wider(names_from = species,
              values_from = n,
              values_fill = 0)

# Number of records per species in unstuctured data
species_composition_2 <- UnstrucHAA %>%
  filter(species %in% studied_spec) %>%
  group_by(species) %>%
  summarise(n = sum(n)) %>% # number of records per species***
  pivot_wider(names_from = species,
              values_from = n,
              values_fill = 0)

# make sure the two datasets have the same columns
addSpp<-setdiff(colnames(species_composition_1), colnames(species_composition_2))
species_composition_2<- species_composition_2 %>% bind_cols(setNames(rep(list(0), length(addSpp)), addSpp))
species_composition_2<-species_composition_2[colnames(species_composition_1)]

#Bray curtis
bray_curtis <- vegan::vegdist(rbind(species_composition_1[-1],
                             species_composition_2[-1]), method = "bray")
bray_curtis #
```

Bray curtis index of 0.49 indicates intermediately dissimilar species composition
